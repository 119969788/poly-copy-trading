# 💰 15分钟套利策略使用指南

## 📋 策略说明

这是一个自动套利策略，实现以下功能：

- **买入条件**：当价格 <= 0.80（赔率80）时自动买入
- **卖出条件**：当价格 >= 0.90（赔率90）时自动卖出
- **持仓超时**：持仓超过15分钟自动卖出（避免长期持仓风险）

---

## ⚙️ 配置说明

### 环境变量配置

在 `.env` 文件中添加以下配置：

```env
# 套利策略配置
ARBITRAGE_BUY_PRICE=0.80      # 买入价格阈值（赔率80）
ARBITRAGE_SELL_PRICE=0.90     # 卖出价格阈值（赔率90）
ARBITRAGE_CHECK_INTERVAL=60000 # 检查间隔（毫秒，默认60秒）
ARBITRAGE_HOLDING_TIMEOUT=900000 # 持仓超时（毫秒，默认15分钟）
ARBITRAGE_TOKEN_ID=           # 要监控的代币ID（可选，不设置则监控所有持仓）
```

### 配置参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `ARBITRAGE_BUY_PRICE` | 买入价格阈值 | 0.80 |
| `ARBITRAGE_SELL_PRICE` | 卖出价格阈值 | 0.90 |
| `ARBITRAGE_CHECK_INTERVAL` | 价格检查间隔（毫秒） | 60000（60秒） |
| `ARBITRAGE_HOLDING_TIMEOUT` | 持仓超时时间（毫秒） | 900000（15分钟） |
| `ARBITRAGE_TOKEN_ID` | 要监控的代币ID | 空（监控所有持仓） |

---

## 🚀 使用方法

### 1. 配置环境变量

编辑 `.env` 文件，添加套利策略配置：

```env
POLYMARKET_PRIVATE_KEY=your_private_key
ARBITRAGE_BUY_PRICE=0.80
ARBITRAGE_SELL_PRICE=0.90
DRY_RUN=true  # 建议先使用模拟模式测试
```

### 2. 运行策略

```bash
# 使用 npm 脚本
npm run arbitrage

# 或直接运行
npx tsx src/arbitrage-strategy.ts
```

### 3. 监控模式

#### 模式 1：监控指定代币

```env
ARBITRAGE_TOKEN_ID=your_token_id_here
```

#### 模式 2：监控所有持仓（默认）

不设置 `ARBITRAGE_TOKEN_ID`，策略会自动监控所有持仓。

---

## 📊 策略工作流程

1. **价格监控**
   - 每60秒（可配置）检查一次价格
   - 获取当前市场价格

2. **买入逻辑**
   - 如果价格 <= 0.80（买入阈值）
   - 且当前无持仓
   - 执行买入操作

3. **卖出逻辑**
   - 如果价格 >= 0.90（卖出阈值）
   - 且当前有持仓
   - 执行卖出操作

4. **持仓超时**
   - 如果持仓超过15分钟
   - 自动卖出（避免长期持仓风险）

---

## 🔍 模拟模式 vs 实盘模式

### 模拟模式（推荐先测试）

```env
DRY_RUN=true
```

- 不会实际执行交易
- 只记录买入/卖出信号
- 用于测试策略逻辑

### 实盘模式

```env
DRY_RUN=false
```

- 实际执行买入/卖出操作
- **请谨慎使用，确保策略正确**

---

## 📝 输出示例

```
═══════════════════════════════════════════════════
   15分钟套利策略
═══════════════════════════════════════════════════

📋 策略配置：
   模式: 🔍 模拟模式
   买入价格阈值: $0.80
   卖出价格阈值: $0.90
   检查间隔: 60 秒
   持仓超时: 15 分钟
   监控模式: 所有持仓

🚀 开始套利策略监控...

   📊 token123: 价格 $0.75 (等待买入)
   
🛒 买入信号触发
   代币ID: token123
   当前价格: $0.7500
   买入价格阈值: $0.80
   🔍 [模拟模式] 将买入代币

   📊 token123: 价格 $0.85 (持仓中，等待卖出)
   
💰 卖出信号触发
   代币ID: token123
   买入价格: $0.7500
   当前价格: $0.9000
   卖出价格阈值: $0.90
   预期利润: $0.1500 (20.00%)
   🔍 [模拟模式] 将卖出代币
```

---

## ⚠️ 重要提示

### SDK API 适配

此策略脚本使用了通用的 SDK 方法调用，但不同版本的 SDK 可能有不同的 API。如果遇到以下问题：

1. **无法获取价格**：需要根据实际 SDK 文档调整 `getMarketPrice` 函数
2. **无法买入/卖出**：需要根据实际 SDK 文档调整 `buyToken` 和 `sellToken` 函数
3. **无法获取持仓**：需要根据实际 SDK 文档调整 `getAllPositions` 函数

**建议**：
- 先使用模拟模式（`DRY_RUN=true`）测试策略逻辑
- 参考 `batch-sell.ts` 中的实现方式
- 查看 SDK 官方文档获取正确的 API 调用方法

---

## ⚠️ 风险提示

1. **价格波动风险**
   - 市场价格可能快速变化
   - 买入后价格可能下跌
   - 建议设置止损

2. **持仓超时**
   - 15分钟后自动卖出
   - 可能以亏损价格卖出
   - 可根据需要调整超时时间

3. **网络延迟**
   - 价格检查有延迟
   - 实际成交价格可能与预期不同
   - 建议使用较小的检查间隔

4. **资金管理**
   - 不要投入超过承受能力的资金
   - 建议先使用模拟模式测试
   - 实盘前充分测试策略

---

## 🆘 故障排查

### 问题 1：无法获取价格

**原因**：代币ID不正确或网络问题

**解决**：
- 检查 `ARBITRAGE_TOKEN_ID` 是否正确
- 检查网络连接
- 查看错误日志

### 问题 2：买入/卖出失败

**原因**：资金不足、价格已变化、网络问题

**解决**：
- 检查账户余额
- 检查价格是否仍在阈值内
- 查看详细错误信息

### 问题 3：策略不执行

**原因**：配置错误、价格未达到阈值

**解决**：
- 检查 `.env` 文件配置
- 确认价格是否在买入/卖出范围内
- 查看日志输出

---

## ⚡ 快速开始

```bash
# 1. 配置 .env 文件
ARBITRAGE_BUY_PRICE=0.80
ARBITRAGE_SELL_PRICE=0.90
DRY_RUN=true

# 2. 运行策略（模拟模式）
npm run arbitrage

# 3. 观察日志，确认策略正常

# 4. 切换到实盘模式（谨慎）
# 编辑 .env: DRY_RUN=false
# 重新运行: npm run arbitrage
```

---

## 📚 相关文档

- [环境变量配置说明](./环境变量配置说明.md)
- [生成 API 凭证指南](./生成API凭证指南.md)
