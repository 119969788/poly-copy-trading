# 15分钟市场暴跌套利策略指南

## 策略原理

这是一个基于15分钟市场的暴跌检测和套利策略：

1. **Leg1（买入信号）**：检测3秒内暴跌30%后自动买入
   - 无论 YES 还是 NO 都会买入（因为暴跌后价格会回归）

2. **Leg2（卖出获利）**：当价格回归理性后卖出获利
   - 目标是花费 0.95 USDC 获得 1 USDC（5%利润）

3. **止损机制**：如果100秒后 Leg2 未执行，自动卖出 Leg1 防止持仓归零

4. **自动 Merge**：买入 Leg2 后自动 merge 回 USDC.e，提高资金效率

5. **自动旋转**：15分钟市场结束后自动进入下一个市场

6. **自动赎回**：市场可以赎回后自动赎回持仓

## 使用方法

### 在本地运行

```bash
# 运行15分钟市场暴跌套利策略
pnpm dip-arb

# 或直接使用 tsx
pnpm tsx src/dip-arb-15m.ts
```

### 在服务器运行

```bash
cd ~/projects/poly-copy-trading
pnpm dip-arb
```

### 使用 PM2 运行

```bash
# 编辑 ecosystem.config.cjs，修改 script 为：
# script: 'src/dip-arb-15m.ts'

pm2 start ecosystem.config.cjs --name dip-arb-15m
pm2 save
```

## 配置参数

在 `.env` 文件中配置：

```env
# 基础配置
POLYMARKET_PRIVATE_KEY=your_private_key_here
DRY_RUN=false

# 币种（ETH, BTC 等）
COIN=ETH

# Leg1 参数
SLIDING_WINDOW_MS=3000    # 3秒滑动窗口
DIP_THRESHOLD=0.3         # 30%暴跌阈值

# Leg2 参数
SUM_TARGET=0.95           # 用0.95 USDC获得1 USDC

# 止损参数
LEG2_TIMEOUT_SECONDS=100  # 100秒后自动卖出Leg1
```

## 参数说明

### Leg1 信号检测参数

- **`SLIDING_WINDOW_MS`** (默认: 3000)
  - 滑动窗口时间（毫秒）
  - 例如：3000 = 3秒内检测暴跌

- **`DIP_THRESHOLD`** (默认: 0.3)
  - 暴跌阈值（0.3 表示 30%）
  - 例如：0.3 = 检测30%的暴跌

### Leg2 退出参数

- **`SUM_TARGET`** (默认: 0.95)
  - 目标成本（用多少 USDC 获得 1 USDC）
  - 例如：0.95 = 用0.95 USDC成本获得1 USDC（5%利润）

### 止损参数

- **`LEG2_TIMEOUT_SECONDS`** (默认: 100)
  - Leg2 超时时间（秒）
  - 如果在这个时间内 Leg2 未执行，自动卖出 Leg1 防止持仓归零

### 币种参数

- **`COIN`** (默认: ETH)
  - 要监控的币种
  - 支持：ETH, BTC 等

## 策略特点

### ✅ 自动化

- **自动检测暴跌**：3秒内检测30%暴跌并自动买入
- **自动获利离场**：价格回归后自动卖出
- **自动止损**：超时后自动卖出防止损失
- **自动 Merge**：买入后自动 merge 回 USDC.e
- **自动旋转**：市场结束后自动进入下一个市场
- **自动赎回**：市场可赎回后自动赎回

### ⚠️ 注意事项

1. **参数调优很重要**
   - 不同参数效果差异很大
   - 推荐使用不太激进的参数
   - 激进参数可能导致频繁交易和手续费损失

2. **15分钟市场有手续费**
   - 市场有手续费后不应跑高频策略
   - 应该使用更保守的参数

3. **大单处理**
   - 如果需要跑大单，SDK 会自动使用 `splitOrders` 拆分成多笔小单

4. **资金效率**
   - 自动 merge 功能可以提高资金效率
   - 买入 Leg2 后自动 merge 回 USDC.e

## 输出示例

```
═══════════════════════════════════════════════════
   15分钟市场暴跌套利策略 (Dip Arbitrage)
═══════════════════════════════════════════════════

📋 配置信息：
   模式: 💰 实盘模式
   币种: ETH
   市场周期: 15分钟
   Leg1 滑动窗口: 3000ms (3秒)
   Leg1 暴跌阈值: 30%
   Leg2 成本目标: 0.95 USDC (获得 1 USDC)
   Leg2 止损时间: 100秒

🚀 正在初始化 SDK...
✅ SDK 初始化成功

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 已启动监控市场
   市场: ETH-15m-xxxx
   币种: ETH
   周期: 15分钟
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⏳ 等待暴跌信号...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📡 Leg1 信号检测到！
   时间: 2026-01-12 22:30:15
   市场: ETH-15m-xxxx
   方向: UP
   价格变化: -30.50%
   当前价格: 0.45
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💰 Leg1 执行成功
   时间: 2026-01-12 22:30:16
   金额: $100
   价格: 0.45
   状态: ✅ 成功
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

...
```

## 推荐参数配置

### 保守配置（推荐）

```env
SLIDING_WINDOW_MS=3000    # 3秒
DIP_THRESHOLD=0.25        # 25%暴跌（更保守）
SUM_TARGET=0.93           # 用0.93获得1（7%利润目标）
LEG2_TIMEOUT_SECONDS=120  # 120秒止损
```

### 中等配置

```env
SLIDING_WINDOW_MS=3000    # 3秒
DIP_THRESHOLD=0.3         # 30%暴跌
SUM_TARGET=0.95           # 用0.95获得1（5%利润目标）
LEG2_TIMEOUT_SECONDS=100  # 100秒止损
```

### 激进配置（不推荐）

```env
SLIDING_WINDOW_MS=2000    # 2秒
DIP_THRESHOLD=0.2         # 20%暴跌（更频繁）
SUM_TARGET=0.98           # 用0.98获得1（2%利润目标）
LEG2_TIMEOUT_SECONDS=60   # 60秒止损
```

⚠️ **警告**：激进配置可能导致频繁交易和手续费损失，不推荐使用。

## 常见问题

### Q: 为什么推荐不太激进的参数？

A: 15分钟市场有手续费，高频交易会产生大量手续费，侵蚀利润。保守参数可以：
- 减少交易频率
- 降低手续费成本
- 提高实际利润

### Q: 自动 merge 是什么？

A: 买入 Leg2 后，自动将持仓 merge 回 USDC.e，这样可以：
- 提高资金效率
- 快速回收资金
- 为下一轮交易做准备

### Q: 自动旋转如何工作？

A: 15分钟市场结束后：
1. 自动停止当前市场监控
2. 自动寻找下一个15分钟市场
3. 如果有可赎回持仓，自动赎回
4. 在新市场继续运行策略

### Q: 止损机制如何工作？

A: 如果 Leg2 在设定的时间（如100秒）内未执行：
1. 自动卖出 Leg1 持仓
2. 防止持仓归零造成损失
3. 为下一轮交易释放资金

## 参考文档

- [poly-sdk README](https://github.com/cyl19970726/poly-sdk/blob/main/README.zh-CN.md)
- [DipArbService 文档](https://github.com/cyl19970726/poly-sdk)

---

**提示**：首次运行建议使用模拟模式（`DRY_RUN=true`）测试参数效果！
