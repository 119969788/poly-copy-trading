# 批量出售代币使用指南

## 功能说明

批量出售代币工具可以自动获取所有持仓并批量出售，支持模拟模式和实盘模式。

## 使用方法

### 1. 确保已安装依赖

```bash
# 如果还没有安装依赖
npm install
# 或
pnpm install
```

### 2. 配置环境变量

确保 `.env` 文件中已配置：

```env
POLYMARKET_PRIVATE_KEY=你的私钥
DRY_RUN=true  # 模拟模式（默认），设为 false 为实盘模式
```

### 3. 运行批量出售

#### 模拟模式（推荐先测试）

```bash
# 使用 pnpm
pnpm batch-sell

# 或使用 npm
npm run batch-sell

# 或直接运行
npx tsx src/batch-sell.ts
```

#### 实盘模式（真实出售）

```bash
# 使用 pnpm
pnpm batch-sell-real

# 或传递参数
pnpm batch-sell --real

# 或直接运行
npx tsx src/batch-sell.ts --real
```

### 4. 自定义参数

```bash
# 设置最小价格 $0.1，最大滑点 5%，延迟 2 秒
npx tsx src/batch-sell.ts --min-price 0.1 --max-slippage 0.05 --delay 2000

# 实盘模式 + 自定义参数
npx tsx src/batch-sell.ts --real --min-price 0.05 --delay 1500
```

## 参数说明

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `--real` | 实盘模式（真实出售） | 模拟模式 | `--real` |
| `--min-price <价格>` | 最小出售价格，低于此价格不出售 | 0（无限制） | `--min-price 0.1` |
| `--max-slippage <滑点>` | 最大滑点（0.03 = 3%） | 0.03 | `--max-slippage 0.05` |
| `--delay <毫秒>` | 每笔交易之间的延迟 | 1000ms | `--delay 2000` |

## 功能特性

- ✅ 自动获取所有持仓
- ✅ 批量出售所有持仓的代币
- ✅ 支持模拟模式（安全测试）
- ✅ 支持实盘模式（真实出售）
- ✅ 可设置最小价格（过滤低价代币）
- ✅ 可设置最大滑点
- ✅ 可设置交易延迟（避免请求过快）
- ✅ 详细的出售日志和统计

## 输出示例

运行后会显示：

```
═══════════════════════════════════════════════════
   Polymarket 批量出售代币工具
═══════════════════════════════════════════════════

📋 配置信息：
   模式: 🔍 模拟模式 (Dry Run)
   最小价格: 无限制
   最大滑点: 3%
   交易延迟: 1000ms

💰 钱包地址: 0x...

🔍 正在获取持仓信息...
📊 找到 5 个持仓

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📈 持仓 #1/5
   市场: market-123
   代币ID: token-456
   数量: 100
   当前价格: $0.5000
   预计价值: $50.00 USDC
   状态: 🔍 模拟出售（不会真实执行）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

...

═══════════════════════════════════════════════════
📊 批量出售总结
═══════════════════════════════════════════════════
   总持仓数: 5
   成功出售: 5
   失败/跳过: 0
   总价值: $250.00 USDC
```

## 注意事项

⚠️ **重要提示**：

1. **默认是模拟模式**：不会真实出售，只模拟逻辑
2. **实盘模式会真实出售**：请谨慎使用 `--real` 参数
3. **建议先测试**：在模拟模式下查看结果，确认无误后再使用实盘模式
4. **确保余额充足**：实盘模式需要足够的 Gas 费用
5. **SDK API 可能不同**：如果遇到错误，可能需要根据实际的 SDK API 调整代码
6. **卖出后无法撤销**：市场订单一旦成交无法撤销
7. **网络延迟**：每个卖出操作之间有延迟，避免请求过快

## 常见问题

### Q: 提示 "SDK 不支持获取持仓功能"？

A: 这可能是因为 SDK 的 API 不同。可以：
- 检查 SDK 文档，确认获取持仓的方法
- 或者手动修改 `src/batch-sell.ts` 中的获取持仓逻辑

### Q: 如何只出售特定价格的代币？

A: 使用 `--min-price` 参数：
```bash
npx tsx src/batch-sell.ts --min-price 0.1
```
这样只会出售价格 >= $0.1 的代币。

### Q: 如何调整交易速度？

A: 使用 `--delay` 参数设置延迟：
```bash
npx tsx src/batch-sell.ts --delay 2000  # 每笔交易延迟 2 秒
```

### Q: 如何查看详细的错误信息？

A: 脚本会显示每个持仓的详细信息，包括错误原因。

### Q: 卖出需要 Gas 费吗？

A: 卖出代币本身不需要 Gas 费（在链下 CLOB 交易），但如果需要将代币转换为 USDC 可能需要 Gas 费。

### Q: 卖出后资金在哪里？

A: 卖出后，资金会以 USDC 形式存入您的 Polymarket 账户余额。

### Q: 可以撤销卖出吗？

A: 市场订单一旦成交无法撤销。如果是限价订单，可以在成交前取消。

## 安全建议

1. ✅ 首次使用建议在模拟模式下测试
2. ✅ 确认配置正确后再使用实盘模式
3. ✅ 定期检查钱包余额和交易记录
4. ✅ 不要将 `.env` 文件分享给他人
5. ✅ 批量卖出前，建议先在模拟模式下运行，确认持仓信息无误后再切换到实盘模式

## 高级用法

### 修改卖出策略

编辑 `src/batch-sell.ts` 文件，可以修改：

1. **订单类型**
   ```typescript
   orderType: 'FAK',  // Fill and Kill（部分成交也可以）
   // 或
   orderType: 'FOK',  // Fill or Kill（完全成交或取消）
   ```

2. **过滤条件**
   ```typescript
   // 只卖出特定市场的持仓
   if (pos.market === 'target-market') {
     // 卖出逻辑
   }
   ```

## 安全检查清单

- [ ] 已在模拟模式下查看持仓
- [ ] 确认要卖出的持仓列表
- [ ] 理解卖出操作不可撤销
- [ ] 已设置 `DRY_RUN=false`（实盘模式）
- [ ] 钱包中有足够的 MATIC 作为 Gas 费（如果需要）
- [ ] 网络连接正常

---

**提示**：批量卖出前，建议先在模拟模式下运行，确认持仓信息无误后再切换到实盘模式！
