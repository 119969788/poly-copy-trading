# 批量卖出代币指南

## 功能说明

批量卖出工具可以一次性卖出所有 Polymarket 持仓代币。

## 使用方法

### 在本地

```bash
# 运行批量卖出脚本
pnpm batch-sell

# 或直接使用 tsx
pnpm tsx src/batch-sell.ts
```

### 在服务器

```bash
# 进入项目目录
cd ~/projects/poly-copy-trading

# 运行批量卖出
pnpm batch-sell

# 或
pnpm tsx src/batch-sell.ts
```

## 工作流程

1. **获取持仓** - 自动获取所有持仓
2. **显示持仓** - 列出所有持仓信息
3. **确认操作** - 显示将要卖出的持仓数量
4. **批量卖出** - 逐个卖出所有持仓
5. **显示结果** - 统计成功和失败的卖出操作

## 模式说明

### 模拟模式（默认）

默认启用模拟模式（`DRY_RUN=true`），只显示持仓信息，不执行真实卖出。

```bash
# 模拟模式（默认）
pnpm batch-sell
```

### 实盘模式

在 `.env` 文件中设置：
```env
DRY_RUN=false
```

然后运行：
```bash
pnpm batch-sell
```

## 输出示例

### 模拟模式输出

```
═══════════════════════════════════════════════════
   Polymarket 批量卖出代币工具
═══════════════════════════════════════════════════

🚀 正在初始化 SDK...
✅ SDK 初始化成功

📊 正在获取持仓信息...

找到 3 个持仓：

持仓 #1:
   市场: will-trump-win-2024
   代币ID: 0x1234...
   数量: 100
   方向: YES
   价值: $45.00

持仓 #2:
   市场: bitcoin-price-2024
   代币ID: 0x5678...
   数量: 50
   方向: NO
   价值: $30.00

🔍 模拟模式：不会执行真实卖出

如需真实卖出，请在 .env 中设置 DRY_RUN=false
```

### 实盘模式输出

```
⚠️  警告：即将卖出所有持仓！
   模式: 💰 实盘模式
   持仓数量: 3

🔄 开始批量卖出...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
卖出持仓 #1/3
   市场: will-trump-win-2024
   代币ID: 0x1234...
   数量: 100
   状态: ✅ 成功
   订单ID: order_12345
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

...

═══════════════════════════════════════════════════
📊 卖出结果统计
═══════════════════════════════════════════════════

总持仓数: 3
成功卖出: 3
失败: 0
```

## 注意事项

### ⚠️ 重要提示

1. **实盘模式会真实卖出**
   - 设置 `DRY_RUN=false` 后，会执行真实卖出操作
   - 卖出后无法撤销

2. **建议先模拟测试**
   - 先在模拟模式下查看持仓
   - 确认无误后再切换到实盘模式

3. **市场订单**
   - 使用市场订单（Market Order）立即成交
   - 订单类型为 FAK（Fill and Kill），部分成交也可以

4. **网络延迟**
   - 每个卖出操作之间有 1 秒延迟，避免请求过快

5. **部分失败处理**
   - 如果某个持仓卖出失败，会继续处理其他持仓
   - 最后会显示失败列表

## 常见问题

### Q: 如何只卖出特定持仓？

A: 当前脚本会卖出所有持仓。如需选择性卖出，可以：
1. 手动在 Polymarket 网站上卖出
2. 修改脚本添加过滤条件

### Q: 卖出需要 Gas 费吗？

A: 卖出代币本身不需要 Gas 费（在链下 CLOB 交易），但如果需要将代币转换为 USDC 可能需要 Gas 费。

### Q: 卖出后资金在哪里？

A: 卖出后，资金会以 USDC 形式存入您的 Polymarket 账户余额。

### Q: 可以撤销卖出吗？

A: 市场订单一旦成交无法撤销。如果是限价订单，可以在成交前取消。

### Q: 卖出失败怎么办？

A: 查看错误信息，常见原因：
- 余额不足
- 市场已关闭
- 网络问题
- 订单被拒绝

可以手动重试失败的持仓。

## 高级用法

### 修改卖出策略

编辑 `src/batch-sell.ts` 文件，可以修改：

1. **订单类型**
   ```typescript
   orderType: 'FAK',  // Fill and Kill（当前）
   // 或
   orderType: 'FOK',  // Fill or Kill
   ```

2. **卖出价格**
   ```typescript
   // 使用限价订单指定价格
   await sdk.tradingService.createLimitOrder({
     tokenId: pos.tokenId,
     side: 'SELL',
     price: 0.45,  // 指定价格
     size: pos.size,
     orderType: 'GTC',
   });
   ```

3. **过滤条件**
   ```typescript
   // 只卖出特定市场的持仓
   if (pos.market === 'target-market') {
     // 卖出逻辑
   }
   ```

## 安全检查清单

- [ ] 已在模拟模式下查看持仓
- [ ] 确认要卖出的持仓列表
- [ ] 理解卖出操作不可撤销
- [ ] 已设置 `DRY_RUN=false`（实盘模式）
- [ ] 钱包中有足够的 MATIC 作为 Gas 费（如果需要）
- [ ] 网络连接正常

---

**提示**：批量卖出前，建议先在模拟模式下运行，确认持仓信息无误后再切换到实盘模式！
